<div class="container">
  <!-- Modern Header Section -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-title">
        <mat-icon class="header-icon">assignment</mat-icon>
        <div class="title-text">
          <h1>Enquiry Management</h1>
          <p>Manage and track all customer enquiries and leads</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Header Actions -->
  <div class="header-actions">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Search enquiries...</mat-label>
      <input matInput [(ngModel)]="searchTerm" (keyup)="applyFilters()" placeholder="Search by name, mobile, staff...">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>
    <button mat-raised-button color="primary" class="add-button" (click)="showAddForm()">
      <mat-icon>add</mat-icon>
      Add New Enquiry
    </button>
  </div>

  <!-- Filters and Sort Section -->
  <mat-card class="filters-card">
    <div class="filters-section">
      <div class="filters-row">
        <!-- Sort Options -->
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Sort By</mat-label>
          <mat-select [(value)]="sortOption" (selectionChange)="onSortChange()">
            <mat-option value="name_asc">Name (A to Z)</mat-option>
            <mat-option value="name_desc">Name (Z to A)</mat-option>
            <mat-option value="date_new">Date (New to Old)</mat-option>
            <mat-option value="date_old">Date (Old to New)</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Staff Filter -->
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Filter by Staff</mat-label>
          <mat-select [(value)]="staffFilter" (selectionChange)="applyFilters()">
            <mat-option value="all">All Staff</mat-option>
            <mat-option *ngFor="let staff of uniqueStaffMembers" [value]="staff">
              {{ staff }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- GST Filter -->
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Filter by GST</mat-label>
          <mat-select [(value)]="gstFilter" (selectionChange)="applyFilters()">
            <mat-option value="all">All</mat-option>
            <mat-option value="yes">GST Active</mat-option>
            <mat-option value="no">No GST / GST Cancelled</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Interest Level Filter -->
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Filter by Interest</mat-label>
          <mat-select [(value)]="interestFilter" (selectionChange)="applyFilters()">
            <mat-option value="all">All</mat-option>
            <mat-option value="interested">Interested</mat-option>
            <mat-option value="not_interested">Not Interested</mat-option>
            <mat-option value="pending">Pending</mat-option>
            <mat-option value="unknown">Unknown</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Date Range Filter -->
        <mat-form-field appearance="outline" class="filter-field date-field">
          <mat-label>From Date</mat-label>
          <input matInput [matDatepicker]="fromDatePicker" [(ngModel)]="fromDate" (dateChange)="applyFilters()">
          <mat-datepicker-toggle matSuffix [for]="fromDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #fromDatePicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field date-field">
          <mat-label>To Date</mat-label>
          <input matInput [matDatepicker]="toDatePicker" [(ngModel)]="toDate" (dateChange)="applyFilters()">
          <mat-datepicker-toggle matSuffix [for]="toDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #toDatePicker></mat-datepicker>
        </mat-form-field>

        <!-- Clear Filters Button -->
        <button mat-stroked-button color="accent" class="clear-filters-btn" (click)="clearAllFilters()" *ngIf="hasActiveFilters()">
          <mat-icon>clear</mat-icon>
          Clear Filters
        </button>
      </div>

      <!-- Active Filters Info -->
      <div class="filter-info" *ngIf="hasActiveFilters()">
        <span class="filter-count">Showing {{ filteredEnquiries.length }} of {{ enquiries.length }} enquiries</span>
        <div class="active-filters">
          <span class="filter-tag" *ngIf="staffFilter !== 'all'">
            Staff: {{ staffFilter }}
            <mat-icon (click)="clearStaffFilter()">close</mat-icon>
          </span>
          <span class="filter-tag" *ngIf="gstFilter !== 'all'">
            GST: {{ gstFilter === 'yes' ? 'Active' : 'No GST / GST Cancelled' }}
            <mat-icon (click)="clearGstFilter()">close</mat-icon>
          </span>
          <span class="filter-tag" *ngIf="interestFilter !== 'all'">
            Interest: {{ getInterestLevelDisplay() }}
            <mat-icon (click)="clearInterestFilter()">close</mat-icon>
          </span>
          <span class="filter-tag" *ngIf="fromDate || toDate">
            Date Range: {{ formatDateRange() }}
            <mat-icon (click)="clearDateRange()">close</mat-icon>
          </span>
        </div>
      </div>
    </div>
  </mat-card>

  <!-- Registration Form Modal -->
  <div class="form-overlay" *ngIf="showRegistrationForm">
    <div class="form-container">
      <div class="form-header">
        <h2>{{ isEditMode ? 'Edit Enquiry' : 'Add New Enquiry' }}</h2>
        <button mat-icon-button (click)="hideAddForm()" class="close-button">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <form [formGroup]="registrationForm" (ngSubmit)="onSubmit()" class="registration-form">
        <div class="form-grid">
          <!-- Row 1 -->
          <mat-form-field appearance="outline">
            <mat-label>Date</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="date" required>
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Wati Name</mat-label>
            <input matInput formControlName="wati_name" required>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>User Name (Optional)</mat-label>
            <input matInput formControlName="user_name">
          </mat-form-field>

          <!-- Row 2 -->
          <mat-form-field appearance="outline">
            <mat-label>Mobile Number (Wati)</mat-label>
            <input matInput formControlName="mobile_number" pattern="[0-9]{10}" maxlength="10" required>
            <mat-error *ngIf="registrationForm.get('mobile_number')?.hasError('pattern')">
              Please enter a valid 10-digit mobile number
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Secondary Mobile Number (Optional)</mat-label>
            <input matInput formControlName="secondary_mobile_number" maxlength="10">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Business Type (Optional)</mat-label>
            <input matInput formControlName="business_type">
          </mat-form-field>

          <!-- Row 3 - GST Section -->
          <div class="gst-section">
            <mat-form-field appearance="outline">
              <mat-label>GST</mat-label>
              <mat-select formControlName="gst" (selectionChange)="onGstChange()" required>
                <mat-option value="Yes">Yes</mat-option>
                <mat-option value="No">No</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" *ngIf="registrationForm.get('gst')?.value === 'Yes'">
              <mat-label>GST Status</mat-label>
              <mat-select formControlName="gst_status">
                <mat-option value="Active">Active</mat-option>
                <mat-option value="Cancel">Cancel</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Row 4 - Staff -->
          <mat-form-field appearance="outline">
            <mat-label>Staff</mat-label>
            <mat-select formControlName="staff" required>
              <mat-option *ngFor="let staff of staffMembers" [value]="staff.username || staff.email">
                {{ staff.username || staff.email }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Row 5 - Comments -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Comments</mat-label>
            <mat-select formControlName="comments" required>
              <mat-option *ngFor="let option of commentOptions" [value]="option">
                {{ option }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Row 6 - Additional Comments -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Additional Comments (Optional)</mat-label>
            <textarea matInput formControlName="additional_comments" rows="3" placeholder="Enter additional comments manually..."></textarea>
          </mat-form-field>
        </div>

        <div class="form-actions">
          <button type="button" mat-button (click)="hideAddForm()">
            Cancel
          </button>
          <button type="submit" mat-raised-button color="primary" [disabled]="!registrationForm.valid">
            {{ isEditMode ? 'Update Enquiry' : 'Add Enquiry' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Enquiry Records Table -->
  <mat-card class="enquiry-records-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>table_chart</mat-icon>
        Enquiry Records
      </mat-card-title>
      <mat-card-subtitle>{{ filteredEnquiries.length }} total enquiries</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>

    <div class="table-wrapper" *ngIf="!loading">
      <table mat-table [dataSource]="filteredEnquiries" class="enquiry-table">
        <!-- S.No Column -->
        <ng-container matColumnDef="sno">
          <th mat-header-cell *matHeaderCellDef class="header-cell">S.No</th>
          <td mat-cell *matCellDef="let enquiry" class="data-cell">{{ enquiry.sno }}</td>
        </ng-container>

        <!-- Date Column -->
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef class="header-cell">Date</th>
          <td mat-cell *matCellDef="let enquiry" class="data-cell">{{ formatDate(enquiry.date) }}</td>
        </ng-container>

        <!-- Wati Name Column -->
        <ng-container matColumnDef="wati_name">
          <th mat-header-cell *matHeaderCellDef class="header-cell">Wati Name</th>
          <td mat-cell *matCellDef="let enquiry" class="data-cell">{{ enquiry.wati_name }}</td>
        </ng-container>

        <!-- User Name Column -->
        <ng-container matColumnDef="user_name">
          <th mat-header-cell *matHeaderCellDef class="header-cell">User Name</th>
          <td mat-cell *matCellDef="let enquiry" class="data-cell">{{ enquiry.user_name || '-' }}</td>
        </ng-container>

        <!-- Mobile Number Column -->
        <ng-container matColumnDef="mobile_number">
          <th mat-header-cell *matHeaderCellDef class="header-cell">Mobile Number</th>
          <td mat-cell *matCellDef="let enquiry" class="data-cell">{{ enquiry.mobile_number }}</td>
        </ng-container>

        <!-- Secondary Mobile Column -->
        <ng-container matColumnDef="secondary_mobile_number">
          <th mat-header-cell *matHeaderCellDef class="header-cell">Secondary Mobile</th>
          <td mat-cell *matCellDef="let enquiry" class="data-cell">{{ enquiry.secondary_mobile_number || '-' }}</td>
        </ng-container>

        <!-- GST Column -->
        <ng-container matColumnDef="gst">
          <th mat-header-cell *matHeaderCellDef class="header-cell">GST</th>
          <td mat-cell *matCellDef="let enquiry" class="data-cell">
            <span class="gst-badge" [class.gst-yes]="enquiry.gst === 'Yes'" [class.gst-no]="enquiry.gst === 'No'">
              {{ enquiry.gst }}
              <span *ngIf="enquiry.gst === 'Yes' && enquiry.gst_status" class="gst-status">
                ({{ enquiry.gst_status }})
              </span>
            </span>
          </td>
        </ng-container>

        <!-- Business Type Column -->
        <ng-container matColumnDef="business_type">
          <th mat-header-cell *matHeaderCellDef class="header-cell">Business Type</th>
          <td mat-cell *matCellDef="let enquiry" class="data-cell">{{ enquiry.business_type || '-' }}</td>
        </ng-container>

        <!-- Staff Column -->
        <ng-container matColumnDef="staff">
          <th mat-header-cell *matHeaderCellDef class="header-cell">Staff</th>
          <td mat-cell *matCellDef="let enquiry" class="data-cell">{{ enquiry.staff }}</td>
        </ng-container>

        <!-- Comments Column -->
        <ng-container matColumnDef="comments">
          <th mat-header-cell *matHeaderCellDef class="header-cell">Comments</th>
          <td mat-cell *matCellDef="let enquiry" class="data-cell">
            <span class="comment-badge">{{ enquiry.comments }}</span>
          </td>
        </ng-container>

        <!-- Additional Comments Column -->
        <ng-container matColumnDef="additional_comments">
          <th mat-header-cell *matHeaderCellDef class="header-cell">Additional Comments</th>
          <td mat-cell *matCellDef="let enquiry" class="data-cell">
            <span class="additional-comment" [title]="enquiry.additional_comments">
              {{ enquiry.additional_comments || '-' }}
            </span>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="header-cell">Actions</th>
          <td mat-cell *matCellDef="let enquiry" class="data-cell">
            <div class="action-buttons">
              <button mat-icon-button color="primary" (click)="editEnquiry(enquiry)" matTooltip="Edit">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="deleteEnquiry(enquiry)" matTooltip="Delete">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" [class]="getRowColorClass(row)"></tr>
      </table>
    </div>

    <!-- Loading State -->
    <div class="loading-container" *ngIf="loading">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Loading enquiries...</p>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="!loading && filteredEnquiries.length === 0">
      <mat-icon>inbox</mat-icon>
      <h3>No Enquiries Found</h3>
      <p>{{ searchTerm ? 'No enquiries match your search criteria.' : 'Start by adding your first enquiry.' }}</p>
      <button mat-raised-button color="primary" (click)="showAddForm()" *ngIf="!searchTerm">
        <mat-icon>add</mat-icon>
        Add First Enquiry
      </button>
    </div>
    </mat-card-content>
  </mat-card>
</div>
