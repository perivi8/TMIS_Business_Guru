<div class="forgot-password-wrapper">
  <div class="card">
    <h2>Reset Password</h2>
    
    <!-- Step indicator -->
    <div class="step-indicator">
      <div class="step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
        <span>1</span>
        <label>Email</label>
      </div>
      <div class="step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
        <span>2</span>
        <label>Verify</label>
      </div>
      <div class="step" [class.active]="currentStep >= 3">
        <span>3</span>
        <label>Reset</label>
      </div>
    </div>

    <div *ngIf="error" class="error">{{ error }}</div>
    <div *ngIf="success" class="success">{{ success }}</div>

    <!-- Step 1: Enter Email -->
    <div *ngIf="currentStep === 1">
      <p class="step-description">Enter your email address to receive a password reset code.</p>
      
      <form [formGroup]="forgotPasswordForm" (ngSubmit)="onSubmitEmail()">
        <div class="form-group">
          <mat-form-field appearance="outline">
            <mat-label>Email</mat-label>
            <input matInput type="email" formControlName="email" placeholder="Enter your email">
            <mat-error *ngIf="f1['email'].invalid && f1['email'].touched">
              <span *ngIf="f1['email'].errors && f1['email'].errors['required']">Email is required</span>
              <span *ngIf="f1['email'].errors && f1['email'].errors['email']">Please enter a valid email</span>
            </mat-error>
          </mat-form-field>
        </div>

        <div class="button-group">
          <button mat-stroked-button type="button" (click)="goBack()">
            Back to Login
          </button>
          <button mat-raised-button color="primary" type="submit" 
                  [disabled]="loading || forgotPasswordForm.invalid">
            <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
            {{ loading ? 'Sending...' : 'Send Reset Code' }}
          </button>
        </div>
      </form>
    </div>

    <!-- Step 2: Verify Code -->
    <div *ngIf="currentStep === 2">
      <p class="step-description">
        Enter the 6-digit code sent to <strong>{{ email }}</strong>
      </p>
      
      <form [formGroup]="verifyCodeForm" (ngSubmit)="onSubmitVerifyCode()">
        <div class="form-group">
          <mat-form-field appearance="outline">
            <mat-label>Reset Code</mat-label>
            <input matInput type="text" formControlName="resetCode" 
                   placeholder="Enter 6-digit code" maxlength="6">
            <mat-error *ngIf="f2['resetCode'].invalid && f2['resetCode'].touched">
              <span *ngIf="f2['resetCode'].errors && f2['resetCode'].errors['required']">Reset code is required</span>
              <span *ngIf="f2['resetCode'].errors && f2['resetCode'].errors['pattern']">Please enter a valid 6-digit code</span>
            </mat-error>
          </mat-form-field>
        </div>

        <div class="resend-section">
          <p>Didn't receive the code? 
            <button mat-button color="primary" type="button" (click)="resendCode()" [disabled]="loading">
              Resend Code
            </button>
          </p>
        </div>

        <div class="button-group">
          <button mat-stroked-button type="button" (click)="goBack()">
            Back
          </button>
          <button mat-raised-button color="primary" type="submit" 
                  [disabled]="loading || verifyCodeForm.invalid">
            <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
            {{ loading ? 'Verifying...' : 'Verify Code' }}
          </button>
        </div>
      </form>
    </div>

    <!-- Step 3: Reset Password -->
    <div *ngIf="currentStep === 3">
      <p class="step-description">Enter your new password.</p>
      
      <form [formGroup]="resetPasswordForm" (ngSubmit)="onSubmitResetPassword()">
        <div class="form-group">
          <mat-form-field appearance="outline">
            <mat-label>New Password</mat-label>
            <input matInput type="password" formControlName="newPassword" 
                   placeholder="Enter new password">
            <mat-error *ngIf="f3['newPassword'].invalid && f3['newPassword'].touched">
              <span *ngIf="f3['newPassword'].errors && f3['newPassword'].errors['required']">Password is required</span>
              <span *ngIf="f3['newPassword'].errors && f3['newPassword'].errors['minlength']">Password must be at least 6 characters</span>
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-group">
          <mat-form-field appearance="outline">
            <mat-label>Confirm Password</mat-label>
            <input matInput type="password" formControlName="confirmPassword" 
                   placeholder="Confirm new password">
            <mat-error *ngIf="f3['confirmPassword'].invalid && f3['confirmPassword'].touched">
              <span *ngIf="f3['confirmPassword'].errors && f3['confirmPassword'].errors['required']">Please confirm your password</span>
            </mat-error>
            <mat-error *ngIf="resetPasswordForm.errors && resetPasswordForm.errors['passwordMismatch'] && f3['confirmPassword'].touched">
              Passwords do not match
            </mat-error>
          </mat-form-field>
        </div>

        <div class="button-group">
          <button mat-stroked-button type="button" (click)="goBack()">
            Back
          </button>
          <button mat-raised-button color="primary" type="submit" 
                  [disabled]="loading || resetPasswordForm.invalid">
            <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
            {{ loading ? 'Resetting...' : 'Reset Password' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
