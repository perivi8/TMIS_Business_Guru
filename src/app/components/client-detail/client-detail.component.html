<div class="client-detail-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading client details...</p>
  </div>

  <!-- Saving Status Changes Loading Overlay -->
  <div *ngIf="saving" class="saving-overlay">
    <div class="saving-content">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Updating client status...</p>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-container">
    <mat-icon>error</mat-icon>
    <h3>Error Loading Client</h3>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
      Back to Clients
    </button>
  </div>

  <!-- Client Details -->
  <div *ngIf="!loading && !error && client" class="client-details">
    <!-- Header Section -->
    <div class="header-section">
      <div class="header-content">
        <button mat-icon-button (click)="goBack()" class="back-button">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="client-title">
          <h1>{{ client.legal_name || client.user_name }}</h1>
          <p class="client-subtitle">{{ client.trade_name || client.business_name }}</p>
        </div>
        <div class="header-actions">
          <span class="status-badge" [style.background-color]="getStatusColor(client.status || 'pending')">
            {{ (client.status || 'pending') | titlecase }}
          </span>
          <div class="action-buttons" *ngIf="isAdmin()">
            <button mat-raised-button color="primary" (click)="startEdit()" *ngIf="!isEditing">
              <mat-icon>edit</mat-icon>
              Edit
            </button>
            <button mat-raised-button color="warn" (click)="deleteClient()" *ngIf="!isEditing">
              <mat-icon>delete</mat-icon>
              Delete
            </button>
            <div *ngIf="isEditing" class="edit-actions">
              <button mat-raised-button color="primary" (click)="saveEdit()" [disabled]="saving">
                <mat-spinner diameter="20" *ngIf="saving"></mat-spinner>
                <mat-icon *ngIf="!saving">save</mat-icon>
                {{ saving ? 'Saving...' : 'Save' }}
              </button>
              <button mat-stroked-button (click)="cancelEdit()" [disabled]="saving">
                <mat-icon>cancel</mat-icon>
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="content-section">
      <!-- First Row: Business Information and Documents & Images side by side -->
      <div class="row-layout">
        <!-- Business Information Card -->
        <mat-card class="info-card half-width">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>business</mat-icon>
            Business Information
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-grid">
            <div class="info-item">
              <label>Legal Name:</label>
              <span>{{ client.legal_name || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>Trade Name/Business Name:</label>
              <span>{{ client.trade_name || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>GST Registration Number:</label>
              <span>{{ getClientProperty('registration_number') || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>GST Status:</label>
              <span>{{ getGSTStatus() }}</span>
            </div>
            <div class="info-item">
              <label>Address:</label>
              <span>{{ client.address || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>District:</label>
              <span>{{ client.district || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>State:</label>
              <span>{{ client.state || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>Pincode:</label>
              <span>{{ client.pincode || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>User Email:</label>
              <span>{{ client.user_email || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>Company Email:</label>
              <span>{{ getClientProperty('company_email') || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>Mobile Number:</label>
              <span>{{ client.mobile_number || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>Optional Mobile Number:</label>
              <span>{{ getClientProperty('optional_mobile_number') || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>Constitution Type:</label>
              <span>{{ client.constitution_type || 'N/A' }}</span>
            </div>
            <div class="info-item" *ngIf="getClientProperty('business_pan_name')">
              <label>Business PAN Name:</label>
              <span>{{ getClientProperty('business_pan_name') }}</span>
            </div>
            <div class="info-item" *ngIf="getClientProperty('business_pan_date')">
              <label>Business PAN Date:</label>
              <span>{{ getClientProperty('business_pan_date') | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="info-item" *ngIf="client.number_of_partners">
              <label>Number of Partners:</label>
              <span>{{ client.number_of_partners }}</span>
            </div>
            <div class="info-item">
              <label>IE Document:</label>
              <span>{{ hasIEDocument() ? 'Yes' : 'No' }}</span>
            </div>
            <div class="info-item">
              <label>Website URL:</label>
              <span>{{ getWebsiteURL() }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

        <!-- Documents & Images and Financial Information Card -->
        <div class="right-column">
          <!-- Documents and Images Card -->
          <mat-card class="info-card" *ngIf="getDocumentKeys().length > 0">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>folder</mat-icon>
                Documents & Images
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="documents-grid">
                <div *ngFor="let docType of getDocumentKeys()" class="document-item">
                  <div class="document-info">
                    <div class="document-header">
                      <mat-icon>{{ isImageFile(client.processed_documents![docType].file_name) ? 'image' : 'description' }}</mat-icon>
                      <div class="document-details">
                        <h4>{{ formatDocumentName(docType) }}</h4>
                        <p class="file-name">{{ client.processed_documents![docType].file_name }}</p>
                        <p class="file-size">{{ formatFileSize(client.processed_documents![docType].file_size) }}</p>
                      </div>
                    </div>
                    <div class="document-actions">
                      <button mat-icon-button (click)="previewDocument(docType)" 
                              matTooltip="Preview {{ formatDocumentName(docType) }}"
                              *ngIf="canPreviewDocument(client.processed_documents![docType].file_name)">
                        <mat-icon>visibility</mat-icon>
                      </button>
                      <button mat-icon-button (click)="downloadDocument(docType)" 
                              matTooltip="Download {{ formatDocumentName(docType) }}">
                        <mat-icon>download</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Financial Information Card -->
          <mat-card class="info-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>account_balance</mat-icon>
                Financial Information
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="info-grid">
                <div class="info-item">
                  <label>Required Loan Amount:</label>
                  <span>₹{{ (client.required_loan_amount | number) || 'N/A' }}</span>
                </div>
                <div class="info-item">
                  <label>Loan Purpose:</label>
                  <span>{{ client.loan_purpose || 'N/A' }}</span>
                </div>
                <div class="info-item">
                  <label>Bank Name:</label>
                  <span>{{ client.bank_name || 'N/A' }}</span>
                </div>
                <div class="info-item">
                  <label>Account Name:</label>
                  <span>{{ client.account_name || 'N/A' }}</span>
                </div>
                <div class="info-item">
                  <label>Bank Account Number:</label>
                  <span>{{ client.account_number || 'N/A' }}</span>
                </div>
                <div class="info-item">
                  <label>IFSC Code:</label>
                  <span>{{ client.ifsc_code || 'N/A' }}</span>
                </div>
                <div class="info-item">
                  <label>Bank Account Type:</label>
                  <span>{{ client.bank_type || 'N/A' }}</span>
                </div>
                <div class="info-item">
                  <label>New Current Account:</label>
                  <span>{{ client.new_current_account === 'yes' ? 'Yes' : (client.new_current_account === 'no' ? 'No' : 'N/A') }}</span>
                </div>
                <div class="info-item">
                  <label>Total Credit Amount:</label>
                  <span>₹{{ (client.total_credit_amount | number) || 'N/A' }}</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <!-- Second Row: Personal Information and Staff Information side by side -->
      <div class="row-layout">
        <!-- Personal Information Card -->
        <mat-card class="info-card half-width">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>person</mat-icon>
              Personal Information
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="info-grid">
              <!-- Owner Information (for Proprietorship and Private Limited) -->
              <div class="info-item" *ngIf="getOwnerName()">
                <label>Owner Name:</label>
                <span>{{ getOwnerName() }}</span>
              </div>
              <div class="info-item" *ngIf="getOwnerDob()">
                <label>Owner Date of Birth:</label>
                <span>{{ getOwnerDob() | date:'dd/MM/yyyy' }}</span>
              </div>
              
              <!-- Partner Information (for Partnership) -->
              <div *ngIf="client.constitution_type === 'Partnership'" class="partners-section">
                <div *ngFor="let partner of getPartnersList(); let i = index" class="partner-info">
                  <div class="info-item" *ngIf="partner.name">
                    <label>{{ i === 0 ? 'Managing Partner' : 'Partner ' + (i + 1) }} Name:</label>
                    <span>{{ partner.name }}</span>
                  </div>
                  <div class="info-item" *ngIf="partner.dob">
                    <label>{{ i === 0 ? 'Managing Partner' : 'Partner ' + (i + 1) }} DOB:</label>
                    <span>{{ partner.dob | date:'dd/MM/yyyy' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Staff Information Card -->
        <mat-card class="info-card half-width">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>support_agent</mat-icon>
            Staff Information
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-grid">
            <div class="info-item">
              <label>Staff Name:</label>
              <span>{{ client.staff_name || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>Staff Email:</label>
              <span>{{ client.staff_email || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>Created At:</label>
              <span>{{ (client.created_at | date:'medium') || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <label>Updated At:</label>
              <span>{{ (client.updated_at | date:'medium') || 'N/A' }}</span>
            </div>
          </div>
        </mat-card-content>
        </mat-card>
      </div>

      <!-- Status and Feedback Card (Editable for Admin) -->
      <mat-card class="info-card" *ngIf="isAdmin()">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>feedback</mat-icon>
            Status & Feedback
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="!isEditing" class="info-grid">
            <div class="info-item">
              <label>Status:</label>
              <span class="status-badge" [style.background-color]="getStatusColor(client.status || 'pending')">
                {{ (client.status || 'pending') | titlecase }}
              </span>
            </div>
            <div class="info-item full-width">
              <label>Feedback:</label>
              <span>{{ client.feedback || 'No feedback provided' }}</span>
            </div>
          </div>
          
          <div *ngIf="isEditing" class="edit-form">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Status</mat-label>
              <mat-select [(value)]="editableClient!.status">
                <mat-option value="pending">Pending</mat-option>
                <mat-option value="processing">Processing</mat-option>
                <mat-option value="interested">Interested</mat-option>
                <mat-option value="not_interested">Not Interested</mat-option>
                <mat-option value="hold">Hold</mat-option>
              </mat-select>
            </mat-form-field>
            
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Feedback</mat-label>
              <textarea matInput [(ngModel)]="editableClient!.feedback" 
                        rows="4" placeholder="Enter feedback for this client"></textarea>
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
